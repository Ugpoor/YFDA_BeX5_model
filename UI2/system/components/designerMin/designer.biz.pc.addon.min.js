/*! 
* BeX5 v3 (http://www.justep.com) 
* Copyright 2015 Justep, Inc.
*/

/*! 
* WeX5 v3 (http://www.justep.com) 
* Copyright 2015 Justep, Inc.
* Licensed under Apache License, Version 2.0 (http://www.apache.org/licenses/LICENSE-2.0) 
*/

define("$model/UI2/system/components/justep/grid/designer/grid",["require","jquery","$UI/system/lib/justep","../grid","$UI/system/components/designerCommon/js/xuiService","$UI/system/lib/base/xml","../js/grid.css","css!./css/grid"],function(require){var $=require("jquery"),justep=require("$UI/system/lib/justep"),RTGrid=require("../grid"),xuiService=require("$UI/system/components/designerCommon/js/xuiService"),xuiDoc=xuiService.getXuiDoc(),XML=require("$UI/system/lib/base/xml"),COMP_EDITOR_FLAG="comp_",COMP_EDITOR="component",EDITOR_INPUT={type:"input",name:"input"},EDITOR_CHECKBOX={type:"checkbox",name:"checkbox"},EDITOR_TEXTAREA={type:"textarea",name:"textarea"},EDITOR_INPUT_COMP={type:COMP_EDITOR_FLAG+"input",name:"Input(组件模式)"},EDITOR_CHECKBOX_COMP={type:COMP_EDITOR_FLAG+"checkbox",name:"Checkbox(组件模式)"},EDITOR_DIRECT_CHECKBOX_COMP={type:COMP_EDITOR_FLAG+"direct_checkbox",name:"直接显示Checkbox(组件模式)"},EDITOR_TEXTAREA_COMP={type:COMP_EDITOR_FLAG+"textarea",name:"Textarea(组件模式)"},EDITOR_SELECT_COMP={type:COMP_EDITOR_FLAG+"select",name:"Select(组件模式)"},EDITOR_INPUT_BTN_COMP={type:COMP_EDITOR_FLAG+"inputbtn",name:"InputButton(组件模式)"},EDITOR_GRIDSELECT_COMP={type:COMP_EDITOR_FLAG+"selectgrid",name:"SelectGrid(组件模式)"},ALL_EDITORS=[EDITOR_INPUT,EDITOR_CHECKBOX,EDITOR_TEXTAREA,EDITOR_INPUT_COMP,EDITOR_CHECKBOX_COMP,EDITOR_DIRECT_CHECKBOX_COMP,EDITOR_TEXTAREA_COMP,EDITOR_SELECT_COMP,EDITOR_INPUT_BTN_COMP,EDITOR_GRIDSELECT_COMP],COMP_EDITORS=[EDITOR_INPUT_COMP,EDITOR_CHECKBOX_COMP,EDITOR_DIRECT_CHECKBOX_COMP,EDITOR_TEXTAREA_COMP,EDITOR_SELECT_COMP,EDITOR_INPUT_BTN_COMP,EDITOR_GRIDSELECT_COMP];require("../js/grid.css"),require("css!./css/grid").load();var _getEditorTemplate=function(e,t){var n;return t===EDITOR_INPUT_COMP.type?n={attr:{multiRowEditor:!1,disableEditorDisplay:!1},xml:'<input component="$UI/system/components/justep/input/input" {0} class="form-control x-edit-focusin"/>'}:t===EDITOR_CHECKBOX_COMP.type?n={attr:{multiRowEditor:!1,disableEditorDisplay:!0},xml:'<span component="$UI/system/components/justep/button/checkbox" class="x-checkbox" {0}></span>'}:t===EDITOR_DIRECT_CHECKBOX_COMP.type?n={attr:{multiRowEditor:!0,disableEditorDisplay:!1},xml:'<span component="$UI/system/components/justep/button/checkbox" class="x-checkbox" {0}></span>'}:t===EDITOR_SELECT_COMP.type?n={attr:{multiRowEditor:!1,disableEditorDisplay:!1},xml:'<select component="$UI/system/components/justep/select/select" {0} bind-optionsCaption="请选择" class="form-control x-edit-focusin"/>'}:t===EDITOR_TEXTAREA_COMP.type?n={attr:{multiRowEditor:!1,disableEditorDisplay:!1},xml:'<textarea component="$UI/system/components/justep/textarea/textarea" class="form-control x-edit-focusin" {0}/>'}:t===EDITOR_INPUT_BTN_COMP.type?n={attr:{multiRowEditor:!1,disableEditorDisplay:!1},xml:'<div class="input-group" component="$UI/system/components/bootstrap/inputGroup/inputGroup"><input type="text" class="form-control x-edit-focusin" component="$UI/system/components/justep/input/input" {0}/><div class="input-group-btn"><a component="$UI/system/components/justep/button/button" class="btn btn-default" label="..."><i></i><span></span></a></div></div>'}:t===EDITOR_GRIDSELECT_COMP.type&&(n={attr:{multiRowEditor:!1,disableEditorDisplay:!1},xml:'<div class="x-gridSelect" component="$UI/system/components/justep/gridSelect/gridSelect" {0}><option></option></div>'}),n&&n.xml&&(n.xml=justep.String.format(n.xml,_getEditorBindRef(e))),n},_getEditorType=function(e){var t="true"==e.attr("multiRowEditor"),n=e.children("editor").children(":first"),r=n.attr("component");if(r==="$UI/system/components/justep/input/input")return EDITOR_INPUT_COMP.type;if(r==="$UI/system/components/justep/button/checkbox"&&t)return EDITOR_DIRECT_CHECKBOX_COMP.type;if(r==="$UI/system/components/justep/button/checkbox"&&!t)return EDITOR_CHECKBOX_COMP.type;if(r==="$UI/system/components/justep/select/select")return EDITOR_SELECT_COMP.type;if(r==="$UI/system/components/justep/textarea/textarea")return EDITOR_TEXTAREA_COMP.type;if(r==="$UI/system/components/justep/gridSelect/gridSelect")return EDITOR_GRIDSELECT_COMP.type;if(r==="$UI/system/components/bootstrap/inputGroup/inputGroup")return EDITOR_INPUT_BTN_COMP.type},_RTGrid=RTGrid.extend({_processFooter:function(){},getDataByExpr:function(e){return this.getModel().comp(e)}}),Grid=RTGrid.extend({constructor:function(e){this.callParent(e)},init:function(e,t){var n=$(this.domNode);this.data=n.attr("data"),n.html("请设置Grid的data属性然后增加Grid列").attr("d_resizable",!1);var r=this;"100%"==n.attr("height")&&n.height("100%"),window.setTimeout(function(){r.repaintGrid()},100),n.on("childUndoRedo",function(){r.repaintTimer&&clearTimeout(r.repaintTimer),r.repaintTimer=setTimeout(function(){r.repaintTimer=null,r.repaintGrid()},150)}).on("childChanged","th",function(e){r.repaintGrid()})},set:function(e){this.callParent(e),"height"in e&&this.$domNode.height(e.height),this.repaintGrid()},editGroup:function(e){var t=this;xuiService.openPage("$UI/system/components/justep/grid/designer/editGroup.w",{title:"分组设置",height:680,xml:e.nodeXml},function(e){var n=$.Deferred(),r=$.Deferred(),i=[];xuiDoc.set(t,{useGroupbar:e.useGroupbar,grouping:e.grouping},function(){n.resolve()});var s=e.groupFields,o="",u="",a="",f="",l="";for(var c=0;c<s.length;c++)o+="<item>"+s[c].field+"</item>",u+="<item>"+s[c].order+"</item>",a+="<item>"+s[c].text+"</item>",f+="<item>"+s[c].summary+"</item>",l+="<item>"+s[c].groupColumnShow+"</item>";var h="<groupingView "+(e.nullText?"nullText='"+e.nullText+"'":"")+" groupCollapse='"+e.groupCollapse+"'>"+(o?"<groupField>"+o+"</groupField>":"")+"</groupingView>";xuiDoc.replaceChild(t,h,{xpathCondition:"*[local-name()='groupingView']",paintComponent:!1},function(){r.resolve()});var p=t.__grid.domNode.grid.headers;$.each(s,function(e,n){var r=t.getColIndex(n.field);if(r>-1){var s=t.getModel().comp(p[r].el),o=$.Deferred();i.push(o),xuiDoc.set(s,{summaryType:n.summaryType,summaryTpl:n.summaryTpl},function(){o.resolve()})}}),i.push(n),i.push(r),$.when.apply($,i).done(function(){t.repaintGrid()})})},editGroupHeaders:function(e){var t=this;xuiService.openPage("$UI/system/components/justep/grid/designer/editGroupHeaders.w",{title:"多列头设置",height:680,xml:e.nodeXml},function(e){var n=$.Deferred(),r=e.groupHeaders;xuiDoc.replaceChild(t,r,{xpathCondition:"*[local-name()='groupHeaders']",paintComponent:!1},function(){n.resolve()}),$.when(n).done(function(){t.repaintGrid()})})},moveColumn:function(e){var t=this;xuiService.openPage("$UI/system/components/justep/grid/designer/moveColumn.w",{title:"调整列顺序",height:680,xml:e.nodeXml},function(e){xuiDoc.replaceChild(t,e.def.join(""),{paintComponent:!1},function(){t.repaintGrid()})})},getDataCols:function(){},appendColumn:function(e){var t=this,n=this.get("data"),r=this.getModel().comp(n);if(!r){alert("请先设置Grid的data属性");return}var i=r.$domNode.attr("d_id"),s=xuiDoc.getEditorDataSource("RuleRelationDatasource.getDatasource",null,i);xuiService.openPage("$UI/system/components/justep/grid/designer/appendColumn.w",{xml:e.nodeXml,cols:s,editors:ALL_EDITORS},function(e){var n=e.cols;if($.isArray(n)){var r=[];for(var i=0;i<n.length;i++){var s=n[i].name,o=n[i].editor,u=_getEditorTemplate(s,o),a="",f="";if(u){if(u.attr)for(var l in u.attr){var c=u.attr[l];f+=" "+l+'="'+c+'"'}a="<editor>"+u.xml+"</editor>"}o&&(0===o.indexOf(COMP_EDITOR_FLAG)&&(o=COMP_EDITOR),f+=' editable="true"',f+=' editor="'+o+'"'),r.push({componentName:"$UI/system/components/justep/grid/grid#column",parentElementId:t.columns_dId,templateContent:'<column width="100" name="'+s+'" '+f+" >"+a+"</column>"})}xuiDoc.batchCreateComponent(r,function(){t.repaintGrid()})}})},repaintGrid:function(){if(this.isRepainting)return;var e=this.get("data"),t=this.getModel().comp(e);if(!t){this.$domNode.html("请设置Grid的data属性然后增加Grid列");return}this.isRepainting=!0;var n=xuiDoc.getNodeByDId(this.$domNode.attr("d_id")),r=this,i=require.toUrl("$UI/system/components/justep/grid/server/transCfg.j");$.ajax({async:!1,dataType:"json",data:{grid:n},type:"POST",url:i,success:function(e){r.createGrid(e,n),r.isRepainting=!1,r.ownerDesigner.setSelection(r.$domNode[0])},error:function(e,t,n){alert("转换Grid的定义失败："+[t,e.readyState,n]),r.isRepainting=!1}})},getColIndex:function(e){var t=-1;if(this.__grid){var n=this.__grid.getGridParam("colModel");for(var r=0;r<n.length;r++)if(e==n[r].name)return r}return t},createEditors:function(){var e=this.__grid.$domNode.find("tr.jqgfirstrow"),t=e.children("td"),n=t.size(),r="<tr class='x-grid-widget-content jqgrow x-row-ltr x-grid-designer-editors'>";for(var i=0;i<n;i++)r+="<td d_canAddChild='true' class='x-grid-editing'/>";r+="</tr>",e.after(r)},createGrid:function(cfg,xuiNode){this.cfg=cfg;if(!this.cfg.colModel||this.cfg.colModel.length<1)this.cfg.colModel=[{label:"请添加列",name:"temp"}];var dIds=this.ownerDesigner.getSelectionIds();this.__grid&&this.__grid.dispose(),this.$domNode.empty(),cfg.parentNode=this.domNode,this.__grid=new _RTGrid(cfg),this.createEditors();var cols=cfg.colModel,headers=this.__grid.domNode.grid.headers,$editorTR=this.__grid.$domNode.find("tr.x-grid-designer-editors"),$editorTDs=$editorTR.children("td");for(var i=0;i<cols.length;i++){var idx=this.getColIndex(cols[i].name);idx>-1&&($($editorTDs[idx]).attr("col",cols[i].name)[cols[i].hidden?"hide":"show"](),$(headers[idx].el).attr({d_id:cols[i].d_id,d_selectable:cols[i].d_selectable,componentName:cols[i].componentName}).prop("colDef",cols[i]))}$.each(headers,function(e){$(headers[e].el).off("click").off("mousedown")});var $tr=$(xuiNode).find("columns");this.columns_dId=$tr.attr("d_id"),this.$domNode.find("tr.x-grid-labels").attr({d_id:$tr.attr("d_id"),d_selectable:!1,componentName:$tr.attr("componentName")}),$tr.find("column").each(function(){var e=$(this),t=e.children("editor");t.size()>0&&$editorTR.children("td[col="+e.attr("name")+"]").attr({d_id:t.attr("d_id"),d_selectable:t.attr("d_selectable"),componentName:t.attr("componentName")}).append(t.children().addClass("customelement editable"))});var self=this;this.__grid.$domNode.on("beforeAddChild","tr.x-grid-designer-editors td",function(e){var t=$(this),n=$tr.find("column[name="+t.attr("col")+"]"),r=xuiDoc.getTemplate(e.componentName),i=t.attr("d_id"),s=!0;t.attr("componentname")||(i=n.attr("d_id"),s=!1,e.componentName="editor",r="<editor>"+r+"</editor>"),xuiDoc.createComponent(e.componentName,i,{paintComponent:s,templateContent:r},function(e){if(s){$("*[d_id='"+$(e).attr("d_id")+"']").addClass("customelement editable");return}var n=$(e);t.attr({d_id:n.attr("d_id"),d_selectable:n.attr("d_selectable"),componentName:n.attr("componentName")}).append(n.children().addClass("customelement editable")),self.ownerDesigner.endCreateComponent(),self.ownerDesigner.setSelection(t.firstChild()[0])}),e.preventDefault()}),this.__grid.$domNode.off("click"),$(this.__grid.domNode.grid.gDiv).find(".x-grid-grp-item-del").on("click",function(){return!1}),this.ownerDesigner.paintChildComponent(this.domNode),dIds=eval(dIds),dIds&&dIds.length>0&&this.ownerDesigner.setSelectionByIds({ids:dIds})}}),_getEditorBindRef=function(e){return e?"bind-ref=\"ref('"+e+"')\"":""},Column=justep.ViewComponent.extend({constructor:function(e){this.callParent(e)},init:function(e,t){},getGrid:function(){var e=this.$domNode.closest("div[componentName='$UI/system/components/justep/grid/grid']")[0];return this.getModel().comp(e)},setEditor:function(){var e=this,t=xuiDoc.getNodeByDId(this.$domNode.attr("d_id")),n=$(XML.fromString(t).documentElement),r=_getEditorType(n),i=n.attr("name");xuiService.openPage("$UI/system/components/justep/grid/designer/editorSelector.w",{title:"设置列编辑器",height:580,width:500,data:{editors:COMP_EDITORS,editType:r}},function(t){e.updateEditor(i,t.type)})},updateEditor:function(e,t){if(!t)return;var n=_getEditorTemplate(e,t),r=this,i=$.Deferred();n.attr?xuiDoc.set(r,n.attr,function(){i.resolve()}):i.resolve();var s=$.Deferred();xuiDoc.replaceChild(r,"<editor>"+n.xml+"</editor>",{xpathCondition:"*[local-name()='editor']",paintComponent:!1},function(){s.resolve()}),$.when(s,i).done(function(){r.repaintGrid()})},onRemove:function(e){var t=this.getGrid(),n=this.$domNode.index(),r=t.$domNode.find("tr.x-grid-designer-editors");$("tr",r.parent()).each(function(){$("td:last",this).hide(),$("td:eq("+n+")",this).remove()})},repaintGrid:function(){var e=this.getGrid();xuiService.getXuiDoc().repaintComponent(e)},eEditor:function(){var e=xuiDoc.getNodeByDId(this.$domNode.attr("d_id")),t=$(XML.fromString(e).documentElement),n=t.children("editor").attr("d_id");n&&(xuiDoc.deleteComponent([n]),this.repaintGrid())},set:function(e){var t=this.getGrid();if(t)if(e&&e.hasOwnProperty("width")){var n=e.width,r=this.$domNode.prop("colDef");t.__grid.setColWidth(r.name,n)}else if(e&&e.hasOwnProperty("editor")){var i=e.editor;xuiDoc.set(this,{editable:!!i}),"component"===i?this.setEditor():this.removeEditor()}else e&&!e.hasOwnProperty("multiRowEditor")&&!e.hasOwnProperty("editable")&&this.repaintGrid()}});return{"$UI/system/components/justep/grid/grid":Grid,"$UI/system/components/justep/grid/grid#column":Column}}),define("$model/UI2/system/components/justep/gridSelect/designer/gridSelect",["require","$UI/system/lib/justep","../gridSelect","$UI/system/components/designerCommon/js/xuiService"],function(e){var t=e("$UI/system/lib/justep"),n=e("../gridSelect"),r=e("$UI/system/components/designerCommon/js/xuiService"),i=r.getXuiDoc(),s=n.extend({_showOption:function(){},set:function(e){if(e&&e.hasOwnProperty("data")){var t=this.getOption();t&&t.set({data:e.data})}},getOption:function(){var e=this.$domNode.find("option")[0];return this.getModel().comp(e)},doInit:function(){this.$domNode.append('<input class="form-control x-gridSelect-input">'),this.$domNode.children().attr("d_selectable",!1)}}),o=t.BindComponent.extend({constructor:function(e){this.data=null,this.callParent(e)},init:function(e,t){var n=$(this.domNode);this.columns_did=n.children("columns").attr("d_id"),this.data=n.attr("data")},appendColumn:function(e){var t=this,n=this.get("data"),s=this.getModel().comp(n);if(!s){alert("请先设置option的data属性");return}var o=s.$domNode.attr("d_id"),u=i.getEditorDataSource("RuleRelationDatasource.getDatasource",null,o);r.openPage("$UI/system/components/justep/dataTables/designer/appendColumn.w",{xml:e.nodeXml,cols:u},function(e){var n=e.cols,r=[];if($.isArray(n)){for(var s=0;s<n.length;s++)r.push('<column width="100" name="'+n[s]+'"/>');if(t.columns_did){var o=[];for(s=0;s<r.length;s++)o.push({componentName:"$UI/system/components/justep/grid/grid#column",parentElementId:t.columns_did,templateContent:r[s]});i.batchCreateComponent(o)}else i.createComponent("$UI/system/components/justep/gridSelect/gridSelect#columns",t,{templateContent:"<columns>"+r.join("")+"</columns>"},function(e){t.columns_did=$(e).attr("d_id")})}})}});return{"$UI/system/components/justep/gridSelect/gridSelect":s,"$UI/system/components/justep/gridSelect/gridSelect#option":o}}),define("$model/UI2/system/components/justep/richTextarea/designer/richTextarea",["require","../richTextarea"],function(e){var t=e("../richTextarea"),n=t.extend({init:function(e,t){this.callParent(e,t),this.on("onInited",function(e){var t=e.source;t.disabledRender(),window.setTimeout(function(){t._resize()},100)})},isDisabled:function(){return!0}});return{"$UI/system/components/justep/richTextarea/richTextarea":n}}),define("$model/UI2/system/components/justep/codeSelect/designer/codeSelect",["require","$UI/system/lib/justep","$UI/system/components/justep/select/designer/select"],function(e){var t=e("$UI/system/lib/justep"),n=e("$UI/system/components/justep/select/designer/select")["$UI/system/components/justep/select/select"],r=n.extend({doInit:function(){this.callParent(),this.$domNode.css({position:"relative"}),this.$domNode.find("div[component='$UI/system/components/justep/data/bizData']").css({position:"absolute",left:10,top:10}).attr("d_selectable",!0)}});return{"$UI/system/components/justep/codeSelect/codeSelect":r}}),define("$model/UI2/system/components/justep/codeSelect/designer/codeSelectPC",["require","$UI/system/lib/justep","$UI/system/components/justep/gridSelect/designer/gridSelect"],function(e){var t=e("$UI/system/lib/justep"),n=e("$UI/system/components/justep/gridSelect/designer/gridSelect")["$UI/system/components/justep/gridSelect/gridSelect"],r=n.extend({doInit:function(){this.callParent(),this.$domNode.css({position:"relative"}),this.$domNode.find("div[component='$UI/system/components/justep/data/bizData']").css({position:"absolute",left:10,top:10}).attr("d_selectable",!0)}});return{"$UI/system/components/justep/codeSelect/codeSelectPC":r}});